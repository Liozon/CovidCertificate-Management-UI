<fieldset>
	<ec-field-wrapper [isError]="userIdsFormArray.touched && userIdsFormArray.hasError('required')">
		<div class="tree-search-input-container">
			<mat-form-field class="tree-search-input">
				<mat-label>{{ "reports.a4a6.search" | translate }}</mat-label>
				<input type="text" matInput
					   (keydown.enter)="setHiddenBySearchValue(treeDataSource.data)"
					   [(ngModel)]="organisationSearchValue"
					   [ngModelOptions]="{standalone: true}"
				/>
				<button *ngIf="organisationSearchValue" type="button" matSuffix mat-icon-button
						(click)="clearOrganisationSearch()">
					<mat-icon
						svgIcon="{{'cancel'}}">
					</mat-icon>
				</button>
			</mat-form-field>
			<button
				type="button"
				mat-button
				(click)="setHiddenBySearchValue(treeDataSource.data)"
				obButton="secondary"
			>
				{{ "reports.a4a6.search" | translate }}
			</button>
		</div>

		<div class="divider"></div>

		<div *ngIf="isUnitTreeLoading; else hasAuthority">
			<mat-progress-bar mode="indeterminate"></mat-progress-bar>
		</div>
		<ng-template #hasAuthority>
			<div *ngIf="!authority; else noFound">
				{{ "reports.a4a6.chooseDataroom" | translate }}
			</div>
			<ng-template #noFound>
				<div *ngIf="isNoneDisplayed()">
					{{ "reports.a4a6.noUnitsFound" | translate }}
				</div>
			</ng-template>
		</ng-template>
		<mat-tree [dataSource]="treeDataSource" [treeControl]="treeControl" class="unit-tree">
			<mat-tree-node class="no-padding" *matTreeNodeDef="let node" [class.unit-tree-invisible]="node.hidden">
				<div class="profiles-container">
					<div class="profiles-node">
						<button type="button" mat-icon-button matTreeNodeToggle>
							<mat-icon
								svgIcon="{{treeControl.isExpanded(node) ? 'chevron-down' : 'chevron-right'}}"></mat-icon>
						</button>
						<div [style.font-weight]="treeControl.isExpanded(node) ? 'bold' : ''">{{node.name}}</div>
					</div>
					<div class="profiles-list-container">
						<ng-container *ngIf="treeControl.isExpanded(node)">
							<ng-container
								*ngIf="getProfiles$(node) | async as profilesDataSource; else profilesLoading">
								<div class="table-container">
									<table class="ob-table ob-table-hover ob-table-sm" mat-table [dataSource]="profilesDataSource">
										<ng-container matColumnDef="select">
											<th mat-header-cell *matHeaderCellDef>
												<mat-checkbox #checkAllCb
															  (change)="$event ? selectedProfilesService.toggleAll(profilesDataSource.data) : null"
															  [checked]="selectedProfilesService.isAllSelected(profilesDataSource.data)"
															  [indeterminate]="!checkAllCb.checked && selectedProfilesService.isSomeSelected(profilesDataSource.data)">
												</mat-checkbox>
											</th>
											<td mat-cell *matCellDef="let profile">
												<mat-checkbox (click)="$event.stopPropagation()"
															  (change)="$event ? selectedProfilesService.toggle(profile) : null"
															  [checked]="selectedProfilesService.isSelected(profile)">
												</mat-checkbox>
											</td>
										</ng-container>
										<ng-container matColumnDef="firstname">
											<th mat-header-cell
												*matHeaderCellDef>{{"reports.a4a6.firstName" | translate}}</th>
											<td mat-cell *matCellDef="let element"> {{element.firstname}} </td>
										</ng-container>
										<ng-container matColumnDef="name">
											<th mat-header-cell
												*matHeaderCellDef>{{"reports.a4a6.surName" | translate}}</th>
											<td mat-cell *matCellDef="let element"> {{element.name}} </td>
										</ng-container>
										<ng-container matColumnDef="userExtId">
											<th mat-header-cell *matHeaderCellDef>Ext_ID</th>
											<td mat-cell *matCellDef="let element"> {{element.userExtId}} </td>
										</ng-container>
										<ng-container matColumnDef="email">
											<th mat-header-cell
												*matHeaderCellDef>{{"reports.a4a6.email" | translate}}</th>
											<td mat-cell *matCellDef="let element"> {{element.email}} </td>
										</ng-container>

										<tr mat-header-row *matHeaderRowDef="TABLE_ROWS; sticky: true"></tr>
										<tr mat-row *matRowDef="let profile; columns: TABLE_ROWS;"
											(click)="selectedProfilesService.toggle(profile)">
										</tr>
									</table>
								</div>
							</ng-container>
							<ng-template #profilesLoading>
								<mat-progress-bar mode="indeterminate"></mat-progress-bar>
							</ng-template>
						</ng-container>
					</div>
				</div>
			</mat-tree-node>

			<mat-nested-tree-node *matTreeNodeDef="let node; when: isVisible" [class.unit-tree-invisible]="node.hidden">
				<div class="mat-tree-node">
					<button type="button" mat-icon-button matTreeNodeToggle>
						<mat-icon
							svgIcon="{{treeControl.isExpanded(node) ? 'chevron-down' : 'chevron-right'}}"></mat-icon>
					</button>
					{{node.name}}
				</div>
				<div [class.unit-tree-invisible]="node.hidden || !treeControl.isExpanded(node)"
					 role="group">
					<ng-container matTreeNodeOutlet></ng-container>
				</div>
			</mat-nested-tree-node>
		</mat-tree>
		<mat-error>
			{{'reports.a4a6.oneUserHasToBeSelected' | translate}}
		</mat-error>
	</ec-field-wrapper>
</fieldset>
